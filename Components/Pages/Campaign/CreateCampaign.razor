@rendermode InteractiveServer
@page "/campaigns/new"
@using LeviathanRipBlog.Components.Pages.Campaign.Models
@using LeviathanRipBlog.Data.Repositories

@inject ILogger<CreateCampaign> Logger
@inject ICampaignRepository CampaignRepository

<PageTitle>Create Campaign</PageTitle>


<CampaignFormComponent Model="Model" SubmitCallBack="Submit" />




@code {
    [SupplyParameterFromForm]
    public CampaignFormModel? Model { get; set; } = new();

    protected override async Task OnInitializedAsync() {
        Model!.Username = await UsernameRetriever.Username;   
        Model!.OwnerId = (await UsernameRetriever.Identity)!;
    }

    private async Task Submit()
    {
        var campaign = Model!.ToNewCampaign(Model);

        try
        {
            var rv = await CampaignRepository.Insert(campaign);
            if(rv <= -1) throw new Exception("Failed to insert campaign");
            NavigationManager.NavigateTo("/campaigns");
        }
        catch (Exception e)
        {
            Logger.LogError(e, "Failed to insert campaign");
        }
    }
}
